function vels = forward_kinematics(chain)
% For a chain of CKBot links, calculate the linear velocity of both the CM
% and link end, along with the angular velocity of the link.
%
% ARGUMENTS
%  chain - A vector of links in the order that they're connected
% 
% RETURNS
%  vels - Nx3x3 vector
%    vels(N,1,:) = velocity of forward link end in link frame
%    vels(N,2,:) = velocity of cm of link in link frame
%    vels(N,3,:) = angular velocity of link in link frame
%


N = length(chain);
vels = zeros(N,3,3);

for i = 2:N
    % Rotation from the previous link to this link's coordinates
    %  IE: transpose of going from this link to the previous
    R_prev = (rotZ(chain(i).q)*chain(i).R_jts)';
    % Vector from backward joint to forward joint
    r_jt_jt = -chain(i).r_im1 + chain(i).r_ip1;
    
    v_prev = r_prev*vels(i-1,1,:);
    
    % Angular velocity - Rotate about the previous link's joint axis at our
    % motor speed (which is attached at our base to the previous joint
    % axis)
    vels(i,3,:) = R_prev*(vels(i-1,3,:) + chain(i).qd*chain(i-1).forward_joint_axis);
   
    % Linear velocity of our forward joint (for the next link to use)
    vels(i,1,:) = v_prev + cross(vels(i,3,:), r_jt_jt);
    
    % Linear velocity of center of mass
    vels(i,2,:) = v_prev + cross(vels(i,3,:), -chain(i).im1);
    
end

end